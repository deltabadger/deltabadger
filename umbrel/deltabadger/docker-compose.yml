# Umbrel App - Deltabadger Docker Compose
# This file is used by Umbrel's app system

version: "3.7"

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    user: "1000:1000"
    environment:
      POSTGRES_USER: deltabadger
      POSTGRES_PASSWORD: ${APP_PASSWORD}
      POSTGRES_DB: deltabadger_production
    volumes:
      - ${APP_DATA_DIR}/postgres:/var/lib/postgresql/data
    restart: on-failure
    stop_grace_period: 1m

  # Redis for Sidekiq, ActionCable, and Cache
  redis:
    image: redis:7-alpine
    user: "1000:1000"
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - ${APP_DATA_DIR}/redis:/data
    restart: on-failure

  # Web server (Puma)
  web:
    image: ghcr.io/deltabadger/deltabadger:${APP_DELTABADGER_VERSION:-latest}
    user: "1000:1000"
    command: web
    environment:
      RAILS_ENV: production
      NODE_ENV: production
      RAILS_LOG_TO_STDOUT: "true"
      RAILS_SERVE_STATIC_FILES: "true"
      AUTO_MIGRATE: "true"
      # Database
      DB_HOST: deltabadger_postgres_1
      DB_PORT: "5432"
      DB_NAME: deltabadger_production
      DB_USER: deltabadger
      DB_PASSWORD: ${APP_PASSWORD}
      # Redis
      REDIS_SIDEKIQ_URL: redis://deltabadger_redis_1:6379/0
      REDIS_CABLE_URL: redis://deltabadger_redis_1:6379/1
      REDIS_CACHE_URL: redis://deltabadger_redis_1:6379/2
      # App secrets
      SECRET_KEY_BASE: ${APP_SEED}-secret-key-base
      DEVISE_SECRET_KEY: ${APP_SEED}-devise-secret
      # Encryption keys (derived from seed for consistency)
      API_KEY_ENCRYPTION_KEY: ${APP_SEED:0:32}
      API_SECRET_ENCRYPTION_KEY: ${APP_SEED:0:32}
      API_PASSPHRASE_ENCRYPTION_KEY: ${APP_SEED:0:32}
      # App URLs
      HOME_PAGE_URL: http://${DEVICE_HOSTNAME}:${APP_DELTABADGER_PORT}
      APP_ROOT_URL: http://${DEVICE_HOSTNAME}:${APP_DELTABADGER_PORT}
      # Performance
      RAILS_MAX_THREADS: "5"
      WEB_CONCURRENCY: "2"
      MAX_DB_CONNECTIONS: "10"
    ports:
      - "${APP_DELTABADGER_PORT}:3000"
    volumes:
      - ${APP_DATA_DIR}/storage:/app/storage
      - ${APP_DATA_DIR}/logs:/app/log
    depends_on:
      - postgres
      - redis
    restart: on-failure

  # Sidekiq background job processor
  sidekiq:
    image: ghcr.io/deltabadger/deltabadger:${APP_DELTABADGER_VERSION:-latest}
    user: "1000:1000"
    command: sidekiq
    environment:
      RAILS_ENV: production
      NODE_ENV: production
      RAILS_LOG_TO_STDOUT: "true"
      # Database
      DB_HOST: deltabadger_postgres_1
      DB_PORT: "5432"
      DB_NAME: deltabadger_production
      DB_USER: deltabadger
      DB_PASSWORD: ${APP_PASSWORD}
      # Redis
      REDIS_SIDEKIQ_URL: redis://deltabadger_redis_1:6379/0
      REDIS_CABLE_URL: redis://deltabadger_redis_1:6379/1
      REDIS_CACHE_URL: redis://deltabadger_redis_1:6379/2
      # App secrets
      SECRET_KEY_BASE: ${APP_SEED}-secret-key-base
      DEVISE_SECRET_KEY: ${APP_SEED}-devise-secret
      # Encryption keys
      API_KEY_ENCRYPTION_KEY: ${APP_SEED:0:32}
      API_SECRET_ENCRYPTION_KEY: ${APP_SEED:0:32}
      API_PASSPHRASE_ENCRYPTION_KEY: ${APP_SEED:0:32}
      # App URLs
      HOME_PAGE_URL: http://${DEVICE_HOSTNAME}:${APP_DELTABADGER_PORT}
      APP_ROOT_URL: http://${DEVICE_HOSTNAME}:${APP_DELTABADGER_PORT}
    volumes:
      - ${APP_DATA_DIR}/storage:/app/storage
      - ${APP_DATA_DIR}/logs:/app/log
    depends_on:
      - postgres
      - redis
      - web
    restart: on-failure

# Umbrel App - Deltabadger Docker Compose
# This file is used by Umbrel's app system

version: "3.7"

services:
  # Redis for Sidekiq, ActionCable, and Cache
  redis:
    image: redis:7-alpine
    user: "1000:1000"
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - ${APP_DATA_DIR}/redis:/data
    restart: on-failure

  # Web server (Puma)
  web:
    image: ghcr.io/deltabadger/deltabadger:${APP_DELTABADGER_VERSION:-latest}
    user: "1000:1000"
    command: web
    environment:
      RAILS_ENV: production
      NODE_ENV: production
      RAILS_LOG_TO_STDOUT: "true"
      RAILS_SERVE_STATIC_FILES: "true"
      AUTO_MIGRATE: "true"
      # Database (SQLite - stored in /app/storage)
      DATABASE_PATH: /app/storage/production.sqlite3
      # Redis
      REDIS_SIDEKIQ_URL: redis://deltabadger_redis_1:6379/0
      REDIS_CABLE_URL: redis://deltabadger_redis_1:6379/1
      REDIS_CACHE_URL: redis://deltabadger_redis_1:6379/2
      # App secrets
      SECRET_KEY_BASE: ${APP_SEED}-secret-key-base
      DEVISE_SECRET_KEY: ${APP_SEED}-devise-secret
      # Encryption key (derived from seed for consistency)
      APP_ENCRYPTION_KEY: ${APP_SEED:0:32}
      # App URLs
      HOME_PAGE_URL: http://${DEVICE_HOSTNAME}:${APP_DELTABADGER_PORT}
      APP_ROOT_URL: http://${DEVICE_HOSTNAME}:${APP_DELTABADGER_PORT}
      # Performance
      RAILS_MAX_THREADS: "5"
      WEB_CONCURRENCY: "2"
    ports:
      - "${APP_DELTABADGER_PORT}:3000"
    volumes:
      - ${APP_DATA_DIR}/storage:/app/storage
      - ${APP_DATA_DIR}/logs:/app/log
    depends_on:
      - redis
    restart: on-failure

  # Sidekiq background job processor
  sidekiq:
    image: ghcr.io/deltabadger/deltabadger:${APP_DELTABADGER_VERSION:-latest}
    user: "1000:1000"
    command: sidekiq
    environment:
      RAILS_ENV: production
      NODE_ENV: production
      RAILS_LOG_TO_STDOUT: "true"
      # Database (SQLite - stored in /app/storage)
      DATABASE_PATH: /app/storage/production.sqlite3
      # Redis
      REDIS_SIDEKIQ_URL: redis://deltabadger_redis_1:6379/0
      REDIS_CABLE_URL: redis://deltabadger_redis_1:6379/1
      REDIS_CACHE_URL: redis://deltabadger_redis_1:6379/2
      # App secrets
      SECRET_KEY_BASE: ${APP_SEED}-secret-key-base
      DEVISE_SECRET_KEY: ${APP_SEED}-devise-secret
      # Encryption key
      APP_ENCRYPTION_KEY: ${APP_SEED:0:32}
      # App URLs
      HOME_PAGE_URL: http://${DEVICE_HOSTNAME}:${APP_DELTABADGER_PORT}
      APP_ROOT_URL: http://${DEVICE_HOSTNAME}:${APP_DELTABADGER_PORT}
    volumes:
      - ${APP_DATA_DIR}/storage:/app/storage
      - ${APP_DATA_DIR}/logs:/app/log
    depends_on:
      - redis
      - web
    restart: on-failure

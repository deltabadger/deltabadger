<%= render 'layouts/modal/base' do %>
  <div class="modal">
    <%= button_tag class: 'modal__close', data: { action: 'modal--base#animateOutCloseAndCleanUp' } do %>
      <%= render partial: 'svg/24x24_close' %>
    <% end %>
    <div class="modal__header">
      <h1 class="modal__title">‚ö†Ô∏è <%= t('subscriptions.confirm_cancel_title', plan: @subscription.name.titleize) %></h1>
    </div>
    <div class="modal__body">

      <!-- Subscription will continue until renewal date -->
      <div class="cancellation-warning">
        <h3><%= t('subscriptions.cancellation.timeline_title') %></h3>
        <p class="cancellation-timeline">
          <%= t('subscriptions.cancellation.continues_until', date: l(@subscription.renews_at, format: :long)) %>
        </p>
        <p class="text-danger">
          <strong><%= t('subscriptions.cancellation.bots_stop_date', date: l(@subscription.renews_at, format: :long)) %></strong>
        </p>
      </div>

      <hr>

      <!-- Features being lost -->
      <div class="features-lost">
        <h3><%= t('subscriptions.cancellation.features_lost_title') %></h3>
        <div class="features-grid">
          <% if @subscription.mini? || @subscription.standard? || @subscription.pro? %>
            <ul class="lost-features-list">
              <li>üìä <%= t('subscriptions.features.rebalanced_dca') %></li>
              <li>üí∞ <%= t('subscriptions.features.feecutter') %></li>
              <li>üìà <%= t('subscriptions.features.smart_intervals') %></li>
            </ul>
          <% end %>

          <% if @subscription.standard? || @subscription.pro? %>
            <ul class="lost-features-list">
              <li>üìä <%= t('subscriptions.features.rebalanced_dca') %></li>
              <li>üì∞ <%= t('subscriptions.features.premium_newsletter') %></li>
              <li>üîç <%= t('subscriptions.features.portfolio_analyzer') %></li>
              <li>üéØ <%= t('subscriptions.features.price_limit') %></li>
              <li>üìà <%= t('subscriptions.features.triggers') %> (<%= t('subscriptions.features.rsi') %>, <%= t('subscriptions.features.sma_ema') %>)</li>
            </ul>
          <% end %>
        </div>
      </div>

      <hr>

      <!-- Affected bots -->
      <div class="affected-bots">
        <h3><%= t('subscriptions.cancellation.affected_bots_title') %></h3>
        <% affected_bots = current_user.bots.working.select do |bot|
             (bot.try(:interval) == 'hour' && !current_user.subscription.free?) ||
             (bot.type == 'Bots::DcaDualAsset') ||
             (bot.try(:price_limited?) && bot.price_limited?) ||
             (bot.try(:indicator_limited?) && bot.indicator_limited?) ||
             (bot.try(:quote_amount_limited?) && bot.quote_amount_limited?)
           end %>

        <% if affected_bots.any? %>
          <div class="alert alert-danger">
            <strong><%= t('subscriptions.cancellation.bots_will_stop_count', count: affected_bots.size) %></strong>
            <ul class="affected-bots-list">
              <% affected_bots.each do |bot| %>
                <li>
                  <strong><%= bot.label.presence || "#{bot.type.demodulize} Bot" %></strong>
                  <span class="bot-exchange">(<%= bot.exchange.name %>)</span>
                  <div class="bot-features">
                    <% reasons = [] %>
                    <% reasons << t('subscriptions.cancellation.bot_features.hourly') if bot.try(:interval) == 'hour' %>
                    <% reasons << t('subscriptions.cancellation.bot_features.rebalanced_dca') if bot.type == 'Bots::DcaDualAsset' %>
                    <% reasons << t('subscriptions.cancellation.bot_features.price_limits') if bot.try(:price_limited?) && bot.price_limited? %>
                    <% reasons << t('subscriptions.cancellation.bot_features.indicators') if bot.try(:indicator_limited?) && bot.indicator_limited? %>
                    <% reasons << t('subscriptions.cancellation.bot_features.amount_limits') if bot.try(:quote_amount_limited?) && bot.quote_amount_limited? %>
                    <%= t('subscriptions.cancellation.will_stop_because', features: reasons.join(', ')) %>
                  </div>
                </li>
              <% end %>
            </ul>
          </div>
        <% else %>
          <p class="text-success">
            <%= t('subscriptions.cancellation.no_affected_bots') %>
          </p>
        <% end %>
      </div>

      <hr>

      <!-- Account limits -->
      <div class="account-limits">
        <h3><%= t('subscriptions.cancellation.new_limits_title') %></h3>
        <div class="limits-comparison">
          <div class="current-limits">
            <h4><%= t('subscriptions.cancellation.current_plan', plan: @subscription.name.titleize) %></h4>
            <ul>
              <% if @subscription.mini? %>
                <li><%= t('subscriptions.features.bots_count', count: 5) %></li>
              <% elsif @subscription.standard? %>
                <li><%= t('subscriptions.features.bots_count', count: 20) %></li>
              <% elsif @subscription.pro? %>
                <li><%= t('subscriptions.features.bots_count', count: 100) %></li>
              <% end %>
              <li><%= t('subscriptions.cancellation.all_exchanges') %></li>
              <li><%= t('subscriptions.cancellation.all_intervals') %></li>
            </ul>
          </div>
          <div class="free-limits">
            <h4><%= t('subscriptions.free') %> <%= t('subscriptions.cancellation.plan_limits') %></h4>
            <ul class="text-danger">
              <li><strong><%= t('subscriptions.cancellation.one_bot_only') %></strong></li>
              <li><strong><%= t('subscriptions.cancellation.daily_weekly_monthly_only') %></strong></li>
              <li><strong><%= t('subscriptions.cancellation.limited_trading_pairs') %></strong></li>
              <li><strong><%= t('subscriptions.cancellation.mini_features_only') %></strong></li>
            </ul>
          </div>
        </div>
      </div>

      <hr>

      <!-- Confirmation checkbox -->
      <%= form_with url: settings_cancel_subscription_path, method: :patch, local: false, data: { turbo_frame: "api_keys" } do |f| %>
        <div class="confirmation-section">
          <h3><%= t('subscriptions.cancellation.confirmation_required') %></h3>

          <div class="checkbox-group">
            <%= f.check_box :understand_bot_shutdown, { id: 'understand_bot_shutdown', class: 'confirmation-checkbox' }, "1", "" %>
            <%= f.label :understand_bot_shutdown, class: 'confirmation-label' do %>
              <% if affected_bots.any? %>
                <%= t('subscriptions.cancellation.understand_bots_shutdown_html',
                      count: affected_bots.size,
                      date: "<strong>#{l(@subscription.renews_at, format: :long)}</strong>".html_safe) %>
              <% else %>
                <%= t('subscriptions.cancellation.understand_no_bots_affected_html',
                      date: "<strong>#{l(@subscription.renews_at, format: :long)}</strong>".html_safe) %>
              <% end %>
            <% end %>
          </div>

          <div class="checkbox-group">
            <%= f.check_box :understand_feature_loss, { id: 'understand_feature_loss', class: 'confirmation-checkbox' }, "1", "" %>
            <%= f.label :understand_feature_loss, class: 'confirmation-label' do %>
              <%= t('subscriptions.cancellation.understand_feature_loss_html',
                    plan: "<strong>#{@subscription.name.titleize}</strong>".html_safe) %>
            <% end %>
          </div>

          <div class="checkbox-group">
            <%= f.check_box :understand_limitations, { id: 'understand_limitations', class: 'confirmation-checkbox' }, "1", "" %>
            <%= f.label :understand_limitations, class: 'confirmation-label' do %>
              <%= t('subscriptions.cancellation.understand_limitations_html') %>
            <% end %>
          </div>
        </div>

        <div class="buttons buttons--row--2">
          <%= button_tag class: 'button button--outline button--large', data: { action: 'modal--base#animateOutCloseAndCleanUp' } do %>
            <%= t('subscriptions.cancellation.keep_subscription') %>
          <% end %>
          <%= f.submit t('subscriptions.cancellation.confirm_cancellation'),
                class: 'button button--danger button--large',
                id: 'cancel-subscription-btn',
                disabled: true %>
        </div>
      <% end %>
    </div>
  </div>
<% end %>
<%= render 'layouts/turbo_modal' do %>
  <div class="modal--search__background">
    <%= form_with url: new_portfolio_asset_path(@portfolio), method: :get, data: { controller: "form-submission", turbo_frame: "asset-picker", form_key_press_target: "form" }, html: { style: "position:relative" } do |form| %>

      <svg class="modal--search__zoom-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="9" stroke-width="2"/><path d="m19 19 4 4" stroke-width="2" stroke-linecap="round"/></svg>
      <%= form.text_field :query, autofocus: true, autocomplete: "off", placeholder: "Search for an assetâ€¦", data: { action: "input->form-submission#submit", form_key_press_target: "input" }, class: "modal--search__input" %>

    <% end %>
    <%= turbo_frame_tag "asset-picker", data: { action: "turbo:submit-end->modals#submitEnd keydown@window->arrow-keys-navigation#navigate", controller: "arrow-keys-navigation" }, class: "modal--search__assets" do %>

      <%# FIXME: test spinner. %>
      <% if @query_assets.blank? %>
        <%# This is just a placeholder to design the style, however it's shown even if no text is input in the form. To solve it I have to enable background tasks, that process the search and broadcast the results once ready. %>
        <div class="loader"></div>
      <% end %>

      <% @query_assets.each_with_index do |asset, index| %>
        <%= form_with model: Asset, url: portfolio_assets_path(@portfolio), data: { arrow_keys_navigation_target: "item" }, class: "modal--search__assets__item" do |form| %>
          <%= form.hidden_field :ticker, value: asset[:ticker] %>
          <%= form.hidden_field :name, value: asset[:name] %>
          <%= form.hidden_field :category, value: asset[:category] %>
          <%= form.hidden_field :color, value: asset[:color] %>
          <%= form.hidden_field :api_id, value: asset[:api_id] %>
          <%= form.hidden_field :country, value: asset[:country] %>
          <%= form.hidden_field :exchange, value: asset[:exchange] %>
          <%= form.hidden_field :url, value: asset[:url] %>
          <%= button_tag type: :submit, data: { arrow_keys_navigation_target: "button" } do %>
            <div class="modal--search__cell modal--search__cell--ticker"><%= asset[:ticker] %></div>
            <% category = asset[:category] == "Cryptocurrency" ? "Crypto" : asset[:category] %>
            <div class="modal--search__cell modal--search__cell--name">
              <% if asset[:url].present? %>
                <%= link_to asset[:url], target: '_blank', rel: 'noopener noreferrer' do %>
                  <%= asset[:name] %>
                  <svg style="display: inline-block; width: 1em; height: 1em;" viewbox="0 0 48 48">
                    <path d="M36 24c-1.2 0-2 0.8-2 2v12c0 1.2-0.8 2-2 2h-22c-1.2 0-2-0.8-2-2v-22c0-1.2 0.8-2 2-2h12c1.2 0 2-0.8 2-2s-0.8-2-2-2h-12c-3.4 0-6 2.6-6 6v22c0 3.4 2.6 6 6 6h22c3.4 0 6-2.6 6-6v-12c0-1.2-0.8-2-2-2z"></path>
                    <path d="M43.8 5.2c-0.2-0.4-0.6-0.8-1-1-0.2-0.2-0.6-0.2-0.8-0.2h-12c-1.2 0-2 0.8-2 2s0.8 2 2 2h7.2l-18.6 18.6c-0.8 0.8-0.8 2 0 2.8 0.4 0.4 0.8 0.6 1.4 0.6s1-0.2 1.4-0.6l18.6-18.6v7.2c0 1.2 0.8 2 2 2s2-0.8 2-2v-12c0-0.2 0-0.6-0.2-0.8z"></path>
                  </svg>
                <% end %>
              <% else %>
                <%= asset[:name] %>
              <% end %>
              <span class="modal--search__cell--name__country" style="margin-left: 1rem"><%= asset[:country] %></span>
            </div>
            <div class="modal--search__cell modal--search__cell--category"><%= category %></div>

          <% end %>
        <% end %>
      <% end %>
    <% end %>
  </div>
<% end %>

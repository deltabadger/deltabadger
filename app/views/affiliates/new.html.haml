- disabled = !current_user.unlimited?

- if disabled
  .alert.alert-primary.db-alert--flex
    %span
      To join our famous referral program, upgrade to one of our paid plans.

    %a.btn.btn-primary{href: upgrade_path}
      %span Upgrade

.row.pt-5
  .col-6
    %h2.mb-5 Referral program registration

    .alert.alert-primary
      %p.mt-1 Our referral program <b>pays up to $50</b><sup>1</sup> per user in BTC (using an exchange ratio from the transaction). Example:
      %ol
        %li For simplicity, the price of Bitcoin is ~$10000, the discount is 10%, and your margin is 20%.
        %li Referee buys a 1-year plan for $49.99, paying after the discount $44.99 what equals 0.0045BTC. You earn 0.001BTC (20% of $49.99).
        %li It doesn't matter if the price of Bitcoin changes in the meantime. Your profit is locked in BTC.
        %li Next time, the referee buys a 4-year plan for $149.99 and pays 0.015BTC. He or she doesn't get a discount anymore, but you still get your 20% what equals 0.003BTC.
        %li You continue to profit as long as you have an active plan<sup>2</sup>, and your total profit per referee does not reach $50.

      %p
        <em>Earning bitcoins is the best kind of dollar-cost averaging!</em>
      %small.mb-2 <sup>1</sup> The limit is either 50USD or 50EUR, depending on the currency of the pricing.
      %br
      %small.mb-5 <sup>2</sup> For the referee, the referral link works even if your subscription has expired.
  .col-6
    .db-referral-program-registration{ class: ("db-referral-program-registration--inactive" if disabled) }
      - if errors.present?
        %ul.pl-3
          - errors.each do |error|
            %li.text-danger= error

      = form_with model: affiliate, local: true, url: affiliate_path do |f|
        .db-box.mb-1
          %h4.mb-4 <span class="db-number">1</span> Referrer

          - presenter = Presenters::Affiliates::New.new(affiliate)

          .form-group.mb-0
            .form-check.form-check-inline
              = f.radio_button :type, "individual", checked: presenter.individual?, class: "mr-2 radio--private", disabled: disabled
              = f.label :type, "Private", value: "individual", class: "form-check-label"
            .form-check.form-check-inline
              = f.radio_button :type, "eu_company", checked: !presenter.individual?, class: "mr-2 radio--eu-company", disabled: disabled
              = f.label :type, "EU company", value: "eu_company", class: "form-check-label"

          .db-form__row.db-form__row--input.db-form-group--eu-company.mt-4{ class: ("db-form-group--eu-company__visible" unless presenter.individual?) }
            = f.text_field :name, disabled: disabled, type: 'text', autocomplete: 'nope', value: "", class: "db-form__input", onchange: 'this.setAttribute("value", this.value);'
            = f.label :name, "Name of the company", class: "db-form__label"

          .db-form__row.db-form__row--input.db-form-group--eu-company{ class: ("db-form-group--eu-company__visible" unless presenter.individual?) }
            = f.text_field :address, disabled: disabled, type: 'text', autocomplete: 'nope', value: "", class: "db-form__input", onchange: 'this.setAttribute("value", this.value);'
            = f.label :address, "Address of the company", class: "db-form__label"

          .db-form__row.db-form__row--input.db-form-group--eu-company.mb-0{ class: ("db-form-group--eu-company__visible" unless presenter.individual?) }
            = f.text_field :vat_number, disabled: disabled, pattern: '^(ATU[0-9]{8}|BE0[0-9]{9}|BG[0-9]{9,10}|CY[0-9]{8}L|CZ[0-9]{8,10}|DE[0-9]{9}|DK[0-9]{8}|EE[0-9]{9}|(EL|GR)[0-9]{9}|ES[0-9A-Z][0-9]{7}[0-9A-Z]|FI[0-9]{8}|FR[0-9A-Z]{2}[0-9]{9}|GB([0-9]{9}([0-9]{3})?|[A-Z]{2}[0-9]{3})|HU[0-9]{8}|IE[0-9]S[0-9]{5}L|IT[0-9]{11}|LT([0-9]{9}|[0-9]{12})|LU[0-9]{8}|LV[0-9]{11}|MT[0-9]{8}|NL[0-9]{9}B[0-9]{2}|PL[0-9]{10}|PT[0-9]{9}|RO[0-9]{2,10}|SE[0-9]{12}|SI[0-9]{8}|SK[0-9]{10})$', type: 'text', autocomplete: 'nope', value: "", class: "db-form__input", onchange: 'this.setAttribute("value", this.value);'
            .db-form__info.db-form__info--invalid
              Invalid EU VAT number
            = f.label :vat_number, "VAT number (optional)", class: "db-form__label"

        .db-box.mb-1
          %h4.pb-3 <span class="db-number">2</span> Payouts

          .db-form__row.db-form__row--input.mb-0
            = f.text_field :btc_address, disabled: disabled, pattern: '^([13][a-km-zA-HJ-NP-Z1-9]{25,34}|bc1[ac-hj-np-zAC-HJ-NP-Z02-9]{11,71})$', type: 'text', autocomplete: 'nope', value: "", class: "db-form__input", onchange: 'this.setAttribute("value", this.value);'
            .db-form__info.db-form__info--invalid
              Invalid Bitcoin address
            = f.label :btc_address, 'Your Bitcoin address', class: "db-form__label"


        .db-box.mb-1
          %h4.pb-3 <span class="db-number">3</span> Settings<sup>*</sup>

          .text-danger.mb-4
            <sup>*</sup>can't be changed later.

          .db-form__row.db-form__row--input.db-form__row--input--referralcode
            = f.text_field :code, id: 'referral-code', disabled: disabled, type: 'text', autocomplete: 'nope', value: "", class: "db-form__input", onchange: 'this.setAttribute("value", this.value);'
            .db-referral-prefix= "deltabadger.com/ref/"
            = f.label :code, 'Pick your referral code', class: "db-form__label"

          .form-group.mb-0
            = f.label :discount_percent do
              You will <b>earn <span class="db-form-label-range--earn-percent">#{presenter.earn_percent_preview}</span>%</b>, and referee will get <b><span class="db-form-label-range--discount-percent">#{presenter.discount_percent_preview}</span>% discount</b>.
            = f.range_field :discount_percent, in: (presenter.min_discount_percent)..(presenter.max_discount_percent), value: presenter.discount_percent, step: presenter.percent_step, data: { sum: presenter.bonus_percent }, class: "db-form-control-range--discount-ratio form-control-range", style: "direction: rtl", disabled: disabled

        .db-box.mb-1
          %h4.pb-3 <span class="db-number">4</span> Visible info

          .mb-0
            %p This is what referees will see during registration. You can add your name and link to your website to let the referee know where the link is coming from. You can also leave it blank:
            %table.table.db-table--checkout.mb-0
              %tbody.table-borderless
                %tr
                  %td.text-success.pr-0(scope="col")
                    <i class="material-icons-round">check_circle</i>
                  %td(scope="col")
                    %b.text-success Congrats! The <span class="db-form-label-range--discount-percent">#{presenter.discount_percent_preview}</span>% discount is active.
                    %span.db-billing-item__info
                      %span.db-form-preview--visible_text{class: ('db-form-preview--visible_text__visible' if affiliate.visible_name.present?)}
                        Thanks to the referral link from
                        %b
                          %a{href: 'javascript:;'} <span class='db-form-preview--visible_name'>#{affiliate.visible_name}</span>.
                      Valid for the first purchase on the platform.

          .form-group
            = f.label :visible_name, "Name on the preview"
            = f.text_field :visible_name, class: 'form-control form-control-lg db-form-control-text--visible_name', disabled: disabled

          .form-group
            = f.label :visible_link, "Link"
            .input-group
              = f.select :visible_link_scheme, [['https://', 'https'], ['http://', 'http']], {}, class: 'form-control form-control-lg db-http-prefix-select', disabled: disabled
              = f.text_field :visible_link, class: 'form-control form-control-lg', disabled: disabled


          - unless disabled
            .form-check.pt-5.text-center
              = f.check_box :check, class: "form-check-input"
              = f.label :check, "I checked everything carefully.", class: "form-check-label"

          - if disabled
            .form-group.db-form-group--main-btn
              %button.btn.btn-success.btn-lg{type: 'submit', disabled: true}
                Let's start!
          - else
            .form-group.db-form-group--main-btn
              %button.btn.btn-success.btn-lg{type: 'submit'}
                Let's start!

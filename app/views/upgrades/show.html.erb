<% content_for :body_class, "view--upgrade" %>

<% if BlackFriday.week? && !current_user.subscription.legendary? %>
  <%= render partial: 'layouts/banners/black_friday', locals: { show_upgrade_button: false } %>
<% end %>

<div class="page-head">
  <%= form_with url: upgrade_path, method: :get, data: { controller: "form--submit", turbo_frame: "upgrade-frame" }, class: "pricing-period-toggle" do |f| %>
    <% @available_variant_days.each do |days| %>
      <% selected = days == @selected_days %>
      <%= tag.label class: "hide_radio_buttons" do %>
        <%= f.radio_button :days, days, checked: selected, data: { action: "change->form--submit#submit" } %>
        <span><%= t("subscriptions.variant_#{days}_days") %></span>
      <% end %>
    <% end %>
  <% end %>
</div>

<%= turbo_frame_tag "upgrade-frame" do %>

  <div class="pricing">
    <div class="pricing__plans">
      <% @payment_options.each do |available_plan_name, payment_option| %>
        <% next if @mini_research_enabled && available_plan_name == 'mini' %>
        <% next if !@mini_research_enabled && available_plan_name == 'mini_research' %>
        <% next if @standard_research_enabled && available_plan_name == 'standard' %>
        <% next if !@standard_research_enabled && available_plan_name == 'standard_research' %>
        <%= tag.div class: "widget widget--pricing widget--pricing--#{available_plan_name.gsub('_research', '')} widget--pricing--other" do %>
          <%= render partial: "upgrades/plan_cards/#{available_plan_name.gsub('_research', '')}", locals: {
            reference_payment_option: @reference_payment_options[available_plan_name],
            reference_duration: @reference_duration,
            payment_option: payment_option,
            path: upgrade_path, # only used in mini & standard plan cards
            mini_research_enabled: @mini_research_enabled, # only used in mini plan card
            standard_research_enabled: @standard_research_enabled, # only used in standard plan card
            legendary_plan: @legendary_plan, # only used in legendary plan card
          } %>
        <% end %>
      <% end %>
    </div>

    <%= tag.div class: "pricing__checkout", data: {
      controller: "zaraz",
      zaraz_is_purchase_value: @paid_payment.present?,
      zaraz_currency_value: @paid_payment&.currency&.upcase || @payment.currency.upcase,
      zaraz_name_value: plan_variant_name(@paid_payment&.subscription_plan_variant || @payment.subscription_plan_variant),
      zaraz_price_value: @paid_payment&.price_with_vat || @payment.price_with_vat
    } do %>
      <%= render partial: "upgrades/summary", locals: {
        payment: @payment,
        payment_options: @payment_options,
        legendary_plan: @legendary_plan,
        reference_duration: @reference_duration
      } %>
      <%= render partial: "upgrades/billing_form", locals: { payment: @payment, name_pattern: @name_pattern } %>
    <% end %>
  </div>

<% end %>

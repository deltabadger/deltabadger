<%= form_with url: upgrade_path, method: :get, data: { controller: "form--submit", turbo_frame: "upgrade-frame" } do |form| %>
  <% available_variant_years.each do |years| %>
    <% selected = selected_payment_option.subscription_plan_variant.years == years %>
    <%= tag.label class: "hide_radio_buttons" do %>
      <%= form.radio_button :years, years, checked: selected, data: { action: "change->form--submit#submit" } %>
      <div>
        <%= years_amount(years) %>
      </div>
    <% end %>
  <% end %>
<% end %>

<%= form_with url: upgrade_path, method: :get, data: { controller: "form--submit", turbo_frame: "upgrade-frame" }, html: { style: "display: flex; grid-gap: 1rem; gap: 1rem; flex-direction: column;" } do |form| %>
  <% current_user.available_plan_names.each do |available_plan_name| %>
    <% selected = selected_payment_option.subscription_plan.name == available_plan_name %>
    <%= tag.label class: "hide_radio_buttons db-plans__item db-plans__item--#{available_plan_name}-plan db-plan-#{available_plan_name} db-plan--#{selected ? 'selected' : 'other'}" do %>
      <%= form.radio_button :plan_name, available_plan_name, checked: selected, data: { action: "change->form--submit#submit" } %>
      <%= render partial: "upgrade/plan_cards/#{available_plan_name}", locals: {
        payment_option: payment_options[available_plan_name],
        legendary_plan: legendary_plan,
      } %>
      <% if available_plan_name == 'legendary' %>
        <%= render partial: 'layouts/svg_bubbleart_01' %>
      <% end %>
    <% end %>
    <% if available_plan_name == 'legendary' %>
      <div class="db-plans__item db-plans__item--discount">
        <div class="db-plans__item__name">
          <%= t('subscriptions.payment.legendary_plan_discount') %>
        </div>
        <div class="db-plans__item__amount">
          <div class="db-plans__item__amount__t db-plans__item__amount__t--discount">
            -<%= format_price(legendary_plan.current_discount, selected_payment_option.currency) %>
          </div>
        </div>
        <div class="db-plans__item__info"><%= t('subscriptions.payment.legendary_plan_discount_info') %></div>
      </div>
    <% end %>
  <% end %>
<% end %>

<% if current_user.subscription.paid? %>
  <div class="db-plans__item db-plans__item--discount db-plan-active-discount">
    <div class="db-plans__item__name"><%= t('subscriptions.payment.active_plan_discount') %></div>
    <div class="db-plans__item__amount">
      <div class="db-plans__item__amount__t db-plans__item__amount__t--discount">
        -<%= format_price(selected_payment_option.current_plan_discount_amount, selected_payment_option.currency) %>
      </div>
    </div>
    <div class="db-plans__item__info"><%= t("subscriptions.payment.compensation_#{current_user.subscription.name}", count: current_user.subscription.days_left) %></div>
  </div>
<% end %>

<% if current_user.eligible_referrer.present? %>
  <% discount_presenter = RefCodesPresenter.new(current_user.eligible_referrer) %>
  <div class="db-plans__item db-plans__item--discount">
    <div class="db-plans__item__name"><%= t('subscriptions.payment.discount', discount_percent: discount_presenter.discount_percent) %></div>
    <div class="db-plans__item__amount">
      <div class="db-plans__item__amount__t db-plans__item__amount__t--discount">
        -<%= format_price(selected_payment_option.referral_discount_amount, selected_payment_option.currency) %>
      </div>
    </div>
    <div class="db-plans__item__info">
      <% if discount_presenter.info? %>
        <%= t('subscriptions.payment.referral_discount_html', visible_link: discount_presenter.visible_path, visible_name: discount_presenter.visible_name) %>
      <% end %>
    </div>
  </div>
<% end %>
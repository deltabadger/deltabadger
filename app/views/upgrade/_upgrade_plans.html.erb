<%= form_with url: upgrade_path, method: :get, data: { controller: "form--submit", turbo_frame: "upgrade-frame" }, local: true do |form| %>
  <% current_user.available_plans.each do |available_plan_name| %>
    <% selected = selected_plan == available_plan_name %>
    <%= tag.label class: "db-plans__item db-plans__item--#{available_plan_name}-plan db-plan-#{available_plan_name} db-plan--#{selected ? 'selected' : 'other'}" do %>
      <%= form.radio_button :plan, available_plan_name, checked: selected, data: { action: "change->form--submit#submit" } %>
      <%= render partial: "#{available_plan_name}_plan_card", locals: {
        payment: payments[available_plan_name],
        currency: currency,
        legendary_plan: available_plan_name == 'legendary' ? legendary_plan : nil,
      } %>
      <% if available_plan_name == 'legendary' %>
        <%= render partial: 'layouts/svg_bubbleart_01' %>
      <% end %>
    <% end %>
    <% if available_plan_name == 'legendary' %>
      <div class="db-plans__item db-plans__item--discount db-plan-legendary-discount">
        <div class="db-plans__item__name">
          <%= t('subscriptions.payment.legendary_plan_discount') %>
        </div>
        <div class="db-plans__item__amount">
          <div class="db-plans__item__amount__t db-plans__item__amount__t--discount">
            <span class='db-plan-legendary-discount'>-<%= format_price(legendary_plan.current_discount, currency) %></span>
          </div>
        </div>
        <div class="db-plans__item__info"><%= t('subscriptions.payment.legendary_plan_discount_info') %></div>
      </div>
    <% end %>
  <% end %>
<% end %>

<% if current_user.subscription_name == 'standard' %>
  <div class="db-plans__item db-plans__item--discount db-plan-active-discount">
    <div class="db-plans__item__name"><%= t('subscriptions.payment.active_plan_discount') %></div>
    <div class="db-plans__item__amount">
      <div class="db-plans__item__amount__t db-plans__item__amount__t--discount">
        <div class="db-show--standard">
          </span><span class='standard-flat-discount-with-vat'>-<%= format_price(payments['standard'].flat_discount, currency) %></span>
        </div>
        <div class="db-show--pro">
          </span><span class='pro-flat-discount-with-vat'>-<%= format_price(payments['pro'].flat_discount, currency) %></span>
        </div>
        <div class="db-show--legendary">
          </span><span class='legendary-flat-discount-with-vat'>-<%= format_price(payments['legendary'].flat_discount, currency) %></span>
        </div>
      </div>
    </div>
    <div class="db-plans__item__info"><%= t('subscriptions.payment.compensation_standard', count: current_user.subscription.days_left) %></div>
  </div>
<% end %>

<% if current_user.subscription_name == 'pro' && legendary_plan.available? %>
  <div class="db-plans__item db-plans__item--discount db-plan-active-discount">
    <div class="db-plans__item__name"><%= t('subscriptions.payment.active_plan_discount') %></div>
    <div class="db-plans__item__amount">
      <div class="db-plans__item__amount__t db-plans__item__amount__t--discount">
        <div class="db-show--pro">
          <span class='pro-flat-discount-with-vat'>-<%= format_price(payments['pro'].flat_discount, currency) %></span>
        </div>
        <div class="db-show--legendary">
          <span class='legendary-flat-discount-with-vat'>-<%= format_price(payments['legendary'].flat_discount, currency) %></span>
        </div>
      </div>
    </div>
    <div class="db-plans__item__info"><%= t('subscriptions.payment.compensation_pro', count: current_user.subscription.days_left) %></div>
  </div>
<% end %>

<% if current_user.eligible_referrer.present? %>
  <% discount_presenter = RefCodesPresenter.new(current_user.eligible_referrer) %>
  <div class="db-plans__item db-plans__item--discount">
    <div class="db-plans__item__name"><%= t('subscriptions.payment.discount', discount_percent: discount_presenter.discount_percent) %></div>
    <div class="db-plans__item__amount">
      <div class="db-plans__item__amount__t db-plans__item__amount__t--discount">
        <% current_user.available_plans.each do |available_plan_name| %>
          <%= tag.div class: "db-show--#{available_plan_name}" do %>
            <%= tag.span class: "#{available_plan_name}-discount-percent-amount" do %>
              -<%= format_price(payments['standard'].referral_discount_amount, currency) %>
            <% end %>
          <% end %>
        <% end %>
      </div>
    </div>
    <div class="db-plans__item__info">
      <% if discount_presenter.info? %>
        <%= t('subscriptions.payment.referral_discount_html', visible_link: discount_presenter.visible_path, visible_name: discount_presenter.visible_name) %>
      <% end %>
    </div>
  </div>
<% end %>
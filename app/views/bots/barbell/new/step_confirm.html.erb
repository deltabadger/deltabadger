<% quote_color = ensure_contrast(@bot.quote_asset&.color || "#8A9BA8") %>
<% base0_color = ensure_contrast(@bot.base0_asset&.color || "#8A9BA8") %>
<% base1_color = ensure_contrast(@bot.base1_asset&.color || "#8A9BA8") %>
<% base0_color_transparent = transparent_color(base0_color, @bot.effective_allocation0) %>
<% base1_color_transparent = transparent_color(base1_color, 1 - @bot.effective_allocation0) %>

<%= render 'layouts/modal/full_page' do %>
  <div class="bot-creation-layout">
    <%= render partial: 'bots/barbell/new/progress_bar', locals: {
      current_step: :api
    } %>
    <div class="bot-creation-preview">
      <div class="flex-row">
        <%= link_to barbell_new_step_exchange_bots_path({
        bots_barbell: {
          label: @bot.label,
          base0_asset_id: @bot.base0_asset_id,
          base1_asset_id: @bot.base1_asset_id,
        }}), data: { turbo_frame: "modal_content" }, class: "sinput sinput--select sinput--exchange sinput--exchange--#{@bot.exchange.name.downcase}" do %>
          <%= render "svg/exchange-#{@bot.exchange.name.downcase}", title: @bot.exchange.name %>
          <%= @bot.exchange.name.capitalize %>
        <% end %>
      </div>
      <%= form_with model: @bot, url: barbell_new_step_confirm_bots_path, method: :get, class: "widget", data: { controller: "form--submit bot--barbell-allocation", bot__barbell_allocation_color0_value: base0_color, bot__barbell_allocation_color1_value: base1_color } do |f| %>
        <%= f.hidden_field :label, value: @bot.label %>
        <%= f.hidden_field :base0_asset_id, value: @bot.base0_asset_id %>
        <%= f.hidden_field :base1_asset_id, value: @bot.base1_asset_id %>
        <%= f.hidden_field :quote_asset_id, value: @bot.quote_asset_id %>
        <%= f.hidden_field :exchange_id, value: @bot.exchange_id %>
        <%= f.hidden_field :allocation0, value: @bot.allocation0 %>
        <%= f.hidden_field :market_cap_adjusted, value: @bot.market_cap_adjusted %>
        <div class="conversational flex-justify-center">
          <%= t('bot.barbell.invest') %>
          <div class="ticker-input ticker-input--autoscale">
            <% value = @bot.quote_amount.present? ? @bot.quote_amount.to_d.to_s('F') : nil %>
            <%= f.number_field :quote_amount, value: value, class: 'numeric-input', min: 0, step: :any, size: 3, data: { controller: "autowidth-input", action: "change->form--submit#submit autowidth-input#resize" }, autofocus: true %>

            <%= link_to @bot.quote_asset.symbol, barbell_new_step_from_asset_bots_path({
            bots_barbell: {
              label: @bot.label,
              base0_asset_id: @bot.base0_asset_id,
              base1_asset_id: @bot.base1_asset_id,
              exchange_id: @bot.exchange_id
            }}), data: { turbo_frame: "modal_content" }, class: "ticker", style: "background: #{quote_color}" %>

          </div>
          /
          <div class="sinput sinput--select">
            <%= t("bot.#{@bot.interval}") %>
            <%= f.select :interval, bot_intervals, { selected: @bot.interval }, data: { action: "change->form--submit#submit" }, disabled: @bot.working? || @bot.pending? %>
          </div>
        </div>

        <div class="barbell">
          <div class="barbell__plate">
            <%= link_to @bot.base0_asset.symbol, barbell_new_step_to_first_asset_bots_path({
            bots_barbell: {
              label: @bot.label
            }}), data: { turbo_frame: "modal_content", bot__barbell_allocation_target: "allocation0BackgroundColor" }, class: "ticker", style: "background: #{base0_color_transparent}" %>
            <b style="color: <%= base0_color_transparent %>" data-bot--barbell-allocation-target="allocation0Color"><span data-bot--barbell-allocation-target="allocation0Text"><%= (@bot.effective_allocation0 * 100).to_i %></span>%</b>
          </div>

          <div class="barbell__bar">
            <div class="slider">
              <%= f.range_field :allocation0, in: 0.0..1.0, step: 0.01, value: @bot.effective_allocation0, class: "slider__input numeric-input", data: { bot__barbell_allocation_target: "allocation0", action: "input->bot--barbell-allocation#updateAllocation0 change->form--submit#submit" }, disabled: @bot.market_cap_adjusted? %>
              <div class="slider__style">
                <%= tag.div class: "slider__style__track", style: "border-left-color: #{base0_color_transparent};  background: #{base1_color_transparent}", data: { bot__barbell_allocation_target: "allocation0SliderTrack" } do %>
                  <%= tag.div class: "slider__style__progress", style: "width: #{@bot.effective_allocation0 * 100}%; background: #{base0_color_transparent}", data: { bot__barbell_allocation_target: "allocation0SliderProgress" } do %>
                    <div class="slider__style__thumb"></div>
                  <% end %>
                <% end %>
              </div>
            </div>
          </div>

          <div class="barbell__plate">
            <%= link_to @bot.base1_asset.symbol, barbell_new_step_to_second_asset_bots_path({
            bots_barbell: {
              label: @bot.label,
              base0_asset_id: @bot.base0_asset_id
            }}), data: { turbo_frame: "modal_content", bot__barbell_allocation_target: "allocation1BackgroundColor" }, class: "ticker", style: "background: #{base1_color_transparent}" %>
            <b style="color: <%= base1_color_transparent %>" data-bot--barbell-allocation-target="allocation1Color"><span data-bot--barbell-allocation-target="allocation1Text"><%= ((1 - @bot.effective_allocation0).round(2) * 100).to_i %></span>%</b>
          </div>
        </div>
      <% end %>

      <%= form_with model: @bot, url: barbell_new_step_confirm_bots_path, method: :get, class: "widget", data: { controller: "form--submit" } do |f| %>
        <%= f.hidden_field :label, value: @bot.label %>
        <%= f.hidden_field :base0_asset_id, value: @bot.base0_asset_id %>
        <%= f.hidden_field :base1_asset_id, value: @bot.base1_asset_id %>
        <%= f.hidden_field :quote_asset_id, value: @bot.quote_asset_id %>
        <%= f.hidden_field :exchange_id, value: @bot.exchange_id %>
        <%= f.hidden_field :quote_amount, value: @bot.quote_amount %>
        <%= f.hidden_field :interval, value: @bot.interval %>
        <%= f.hidden_field :allocation0, value: @bot.allocation0 %>
        <div class="toggle">
          <%= f.check_box :market_cap_adjusted, data: { action: "change->form--submit#submit" } %>
          <div class="toggle__style"></div>
          <%= f.label :market_cap_adjusted, t('bot.utils.mkt_cap_adjusted'), class: "label" %>

          <div class="tooltip-info-icon" data-controller="tooltip" data-action="click->tooltip#toggle">
            <div class="tooltip-icon--off">
              <%= render 'svg/24x24_info' %>
            </div>
            <div class="tooltip-icon--on">
              <%= render 'svg/24x24_info-filled' %>
            </div>
            <div class="tooltip tooltip--smart-allocation">
              <%= t('bot.utils.mkt_cap_adjusted_info') %>
            </div>
          </div>
        </div>
      <% end %>

    </div>
    <%= form_with model: @bot, url: bots_path(@bot), method: :post, data: { action: "turbo:submit-end->modal--base#submitEnd" } do |f| %>
      <%= f.hidden_field :label, value: @bot.label %>
      <%= f.hidden_field :base0_asset_id, value: @bot.base0_asset_id %>
      <%= f.hidden_field :base1_asset_id, value: @bot.base1_asset_id %>
      <%= f.hidden_field :quote_asset_id, value: @bot.quote_asset_id %>
      <%= f.hidden_field :exchange_id, value: @bot.exchange_id %>
      <%= f.hidden_field :quote_amount, value: @bot.quote_amount %>
      <%= f.hidden_field :interval, value: @bot.interval %>
      <%= f.hidden_field :allocation0, value: @bot.allocation0 %>
      <%= f.hidden_field :market_cap_adjusted, value: @bot.market_cap_adjusted %>
      <%= f.submit t('button.start'), class: 'button button--large button--success', style: "min-width: 30rem", disabled: @bot.quote_amount.blank? || @bot.quote_amount.to_d.zero? %>
    <% end %>
  </div>
<% end %>

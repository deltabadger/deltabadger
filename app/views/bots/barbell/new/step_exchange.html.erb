<% quote_color = ensure_contrast(@bot.quote_asset&.color || "#8A9BA8") %>
<% base0_color = ensure_contrast(@bot.base0_asset&.color || "#8A9BA8") %>
<% base1_color = ensure_contrast(@bot.base1_asset&.color || "#8A9BA8") %>

<%= render 'layouts/modal/full_page' do %>
  <%= render partial: 'bots/barbell/new/progress_bar', locals: {
    current_step: :exchange
  } %>
  <div class="conversational conversational--bot-setup">
    <%= t('bots.setup.sentence.invest_in') %>

    <%= link_to @bot.base0_asset.symbol, barbell_new_step_to_first_asset_bots_path({
    bots_barbell: {
      label: @bot.label,
    }}), data: { turbo_frame: "modal_content" }, class: "ticker", style: "background: #{base0_color}" %>

    <%= t('bots.setup.sentence.and') %>

    <%= link_to @bot.base1_asset.symbol, barbell_new_step_to_second_asset_bots_path({
    bots_barbell: {
      label: @bot.label,
      base0_asset_id: @bot.base0_asset_id,
    }}), data: { turbo_frame: "modal_content" }, class: "ticker", style: "background: #{base1_color}" %>

    <%= t('bots.setup.sentence.at') %>

    <%= form_with model: @bot, url: barbell_new_step_exchange_bots_path, method: :get, data: { controller: "form--submit-after-delay", turbo_frame: "exchange-picker" } do |f| %>
      <%= f.hidden_field :label, value: @bot.label %>
      <%= f.hidden_field :base0_asset_id, value: @bot.base0_asset_id %>
      <%= f.hidden_field :base1_asset_id, value: @bot.base1_asset_id %>
      <%= f.hidden_field :quote_asset_id, value: @bot.quote_asset_id %>
      <%= f.text_field :query, autofocus: true, autocomplete: "off", placeholder: "…", data: { action: "input->form--submit-after-delay#submit" }, class: "conversational__input" %>
    <% end %>
  </div>

  <%= turbo_frame_tag "exchange-picker", data: { action: "keydown@window->arrow-keys-navigation#navigate", controller: "arrow-keys-navigation" }, class: "modal--search__assets" do %>
    <%# FIXME: test spinner. %>
    <% if @exchanges.blank? %>
      <%# This is just a placeholder to design the style, however it's shown even if no text is input in the form. To solve it I have to enable background tasks, that process the search and broadcast the results once ready. %>
      <div class="loader"></div>
    <% else %>
      <div class="db-bot__exchanges__item db-bot__exchanges__item--header">
        <div>Fees:</div>
        <div>Maker</div>
        <div>Taker</div>
        <div>Withdrawal (₿)</div>
      </div>
      <% @exchanges.each_with_index do |exchange, index| %>
        <%= form_with model: @bot, url: barbell_new_step_api_key_bots_path, method: :get, data: { arrow_keys_navigation_target: "item" } do |f| %>
          <%= f.hidden_field :label, value: @bot.label %>
          <%= f.hidden_field :base0_asset_id, value: @bot.base0_asset_id %>
          <%= f.hidden_field :base1_asset_id, value: @bot.base1_asset_id %>
          <%= f.hidden_field :quote_asset_id, value: @bot.quote_asset_id %>
          <%= f.hidden_field :exchange_id, value: exchange.id %>
          <%= button_tag type: :submit, data: { arrow_keys_navigation_target: "button", turbo_frame: "modal_content" }, class: "db-bot__exchanges__item db-bot__exchanges__item--binance" do %>
            <div><%= exchange.name.capitalize %></div>
            <div><%= "#{exchange.maker_fee || '-'}%" %></div>
            <div><%= "#{exchange.taker_fee || '-'}%" %></div>
            <div><%= exchange.withdrawal_fee || '-' %></div>
          <% end %>
        <% end %>
      <% end %>
    <% end %>
  <% end %>

<% end %>

<%= form_with model: bot,
              url: path,
              method: method,
              class: "widget #{bot.moving_average_limited? ? "bot-settings--active" : "bot-settings--inactive"}",
              data: {
                controller: "class-toggle form--submit form--submit-after-delay form--move-cursor-to-end form--html5-validations",
                class_toggle_target: "togglable",
                class_toggle_toggle_classes_value: ["bot-settings--active", "bot-settings--inactive"],
                turbo_stream: true
              } do |f| %>
  <div class="toggle-group">
    <div class="toggle">
      <%= f.check_box :moving_average_limited, data: { action: "change->form--submit#submit change->class-toggle#toggle" }, disabled: bot.working? %>
      <div class="toggle__style"></div>
    </div>
    <div class="toggle-group__info">
      <div class="toggle-group__info__label">
        <%= f.label :moving_average_limited, class: "conversational conversational--small conversational--disabled" do %>
          <% timing_condition_html = content_tag(:div, class: "sinput sinput--select #{'sinput--disabled' if bot.working?}") do %>
            <%= t("bot.settings.extra_moving_average_limit.timing_condition.#{bot.moving_average_limit_timing_condition}") %>
            <%= f.select :moving_average_limit_timing_condition, moving_average_limit_timing_condition_select_options(bot), { selected: bot.moving_average_limit_timing_condition }, data: { action: "change->form--submit#submit" }, disabled: bot.working? %>
          <% end %>
          <% value_condition_html = content_tag(:div, class: "sinput sinput--select #{'sinput--disabled' if bot.working?}") do %>
            <%= t("bot.settings.extra_moving_average_limit.value_condition.#{bot.moving_average_limit_value_condition}") %>
            <%= f.select :moving_average_limit_value_condition, moving_average_limit_value_condition_select_options(bot), { selected: bot.moving_average_limit_value_condition }, data: { action: "change->form--submit#submit" }, disabled: bot.working? %>
          <% end %>
          <% if moving_average_select_options.size > 1 %>
            <% ma_html = content_tag(:div, class: "sinput sinput--select #{'sinput--disabled' if bot.working?}") do %>
              <%= bot.moving_average_limit_in_ma_type&.upcase %>
              <%= f.select :moving_average_limit_in_ma_type, moving_average_select_options, { selected: bot.moving_average_limit_in_ma_type }, data: { action: "change->form--submit#submit" }, disabled: bot.working? %>
            <% end %>
          <% else %>
            <% ma_html = moving_average_select_options.first.first %>
          <% end %>
          <% ma_period_html = content_tag(:div) do %>
            <%= f.number_field :moving_average_limit_in_period, class: 'sinput numeric-input', step: 1, size: 2, data: { controller: "autowidth-input", action: "input->form--submit-after-delay#submit input->autowidth-input#resize", form__move_cursor_to_end_target: "input" }, style: "margin-left: 0.125rem; width: 50px;", disabled: bot.working? %>
          <% end %>
          <% selected_ticker = bot.tickers.find_by(id: bot.moving_average_limit_in_ticker_id) %>
          <% ticker_select_options = ticker_select_options(bot) %>
          <% if ticker_select_options.size > 1 %>
            <% ticker_html = content_tag(:div, class: "sinput sinput--select #{'sinput--disabled' if bot.working?}") do %>
              <% selected_ticker_id = selected_ticker&.id %>
              <%= ticker_select_options.find { |_, id| id == selected_ticker_id }&.first %>
              <%= f.select :moving_average_limit_in_ticker_id, ticker_select_options, { selected: bot.moving_average_limit_in_ticker_id }, data: { action: "change->form--submit#submit" }, disabled: bot.working? %>
            <% end %>
          <% else %>
            <% ticker_html = ticker_select_options.first&.first || "" %>
          <% end %>
          <% if moving_average_limit_timeframe_select_options.size > 1 %>
            <% timeframe_html = content_tag(:div, class: "sinput sinput--select #{'sinput--disabled' if bot.working?}") do %>
              <%= t("bot.settings.extra_moving_average_limit.timeframe.#{bot.moving_average_limit_in_timeframe}") %>
              <%= f.select :moving_average_limit_in_timeframe, moving_average_limit_timeframe_select_options, { selected: bot.moving_average_limit_in_timeframe }, data: { action: "change->form--submit#submit" }, disabled: bot.working? %>
            <% end %>
          <% else %>
            <% timeframe_html = moving_average_limit_timeframe_select_options.first.first %>
          <% end %>
          <%= t("bot.settings.extra_moving_average_limit.sentence_html",
                timing_condition_html: timing_condition_html.html_safe,
                base: ticker_select_options.size > 1 ? selected_ticker&.base_asset&.symbol : "",
                value_condition_html: value_condition_html.html_safe,
                ma_html: ma_html.html_safe,
                ma_period_html: ma_period_html.html_safe,
                ticker_html: ticker_html.html_safe,
                timeframe_html: timeframe_html.html_safe,
                count: ticker_select_options.size).html_safe %>
          <%= render partial: "bots/settings/moving_average_limit_info", locals: { bot: bot, info: bot.moving_average_limit_info_from_cache } %>
        <% end %>
      </div>
    </div>
  </div>
<% end %>

